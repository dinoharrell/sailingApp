<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Speed Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { background-color: #0d1117; color: #ffffff; }
        .speed-display { font-size: 5rem; line-height: 1; }
        .unit { font-size: 1.5rem; opacity: 0.7; margin-top: -10px; }
        .data-box { @apply text-center bg-gray-800 p-6 rounded-lg shadow-2xl w-full; margin-bottom: 1.5rem;}
        .chart-box { 
            @apply bg-gray-800 p-4 rounded-lg shadow-2xl w-full; 
            max-height: 350px; 
            position: relative; 
        }
        .bg-yellow-600 { background-color: #d97706; }
        .bg-green-700 { background-color: #047857; }
        .bg-red-500 { background-color: #ef4444; }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen">

    <h1 class="text-xl font-bold mb-6 text-gray-400">SAILING SPEED MONITOR v3.0 (GPS SOG)</h1>

    <div class="w-full max-w-lg space-y-4">
        <div class="data-box"><p class="text-2xl mb-2 text-blue-400">AVG (LAST 10 SEC)</p><p id="avg-speed-10" class="speed-display font-mono text-green-400">--.-</p><p class="unit">KNOTS</p></div>
        <div class="data-box"><p class="text-2xl mb-2 text-blue-400">AVG (LAST 30 SEC)</p><p id="avg-speed-30" class="speed-display font-mono text-yellow-400">--.-</p><p class="unit">KNOTS</p></div>
        <div class="chart-box"><p class="text-xl mb-2 text-blue-400 text-left">RAW SPEED (LAST 60 SEC)</p><canvas id="speedChart"></canvas></div>
    </div>
    <div class="mt-8 p-3 w-full max-w-lg rounded bg-red-800 text-white" id="status-box">
        <p id="status-message" class="text-sm">Initializing GPS...</p>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const AVERAGE_WINDOW_10_SEC = 10;
        const AVERAGE_WINDOW_30_SEC = 30;
        const GRAPH_WINDOW_SEC = 60;
        const MAX_SAILING_SPEED_KNOTS = 7.0;
        const MAX_ACCELERATION_KNOTS_PER_SEC = 1.0;
        const MIN_SPEED_KNOTS = 0.05;
        const MAX_HORIZONTAL_ACCURACY_METERS = 10.0; // NEW: Reject fixes worse than 10 meters accuracy
        
        const KNOTS_PER_METER_PER_SECOND = 1.94384;
        const DATA_KEY = 'sailingSpeedData';

        // --- 2. DATA STRUCTURE & GLOBALS ---
        let speedBuffer = [];
        let watchId; 
        let speedChart;
        // lastPosition is still used to calculate time_sec for the acceleration filter
        let lastPosition = null; 

        // --- 3. GEOMETRY FUNCTIONS (Distance calculation is now deprecated/unused) ---
        // function getDistance() is no longer needed/used for speed calculation
        
        // This function is kept primarily to calculate time_sec for the acceleration filter
        function calculateTimeDelta(current) {
            if (lastPosition) {
                const timeSeconds = (current.timestamp - lastPosition.timestamp) / 1000;
                return timeSeconds > 0 ? timeSeconds : 0;
            }
            return 0;
        }

        // --- 4. PERSISTENCE, CORE LOGIC, CHART UTILS (Unchanged) ---
        function loadData() { /* ... */ }
        function saveData() { /* ... */ }
        function calculateRollingAverage(windowSeconds) { /* ... */ }
        function mpsToKnots(mps) { return mps * KNOTS_PER_METER_PER_SECOND; }
        function updateDisplay(elementId, speed) { /* ... */ }
        function showStatus(message, isError = false, isAccepted = false) { /* ... */ }
        function initChart() { /* ... */ }
        function updateChart() { /* ... */ }


        // --- 5. GEOLOCATION HANDLERS (The Core Logic Change) ---

        function handlePosition(position) {
            const currentCoords = position.coords;
            const timestamp = position.timestamp;
            
            // 1. CRITICAL FIX: Save the very first fix and exit.
            if (lastPosition === null) {
                lastPosition = position;
                showStatus("Waiting for a second GPS fix...", false);
                return; 
            }

            const time_sec = calculateTimeDelta(position);
            
            // --- NEW FILTER 1: ACCURACY CHECK ---
            if (currentCoords.accuracy > MAX_HORIZONTAL_ACCURACY_METERS) {
                showStatus(`Fix rejected. Accuracy (${currentCoords.accuracy.toFixed(1)}m) is worse than ${MAX_HORIZONTAL_ACCURACY_METERS.toFixed(1)}m.`, false);
                return;
            }

            // --- NEW CALCULATION: USE HARDWARE SPEED ---
            const speed_mps = currentCoords.speed !== null ? currentCoords.speed : 0;
            const speedInKnots = mpsToKnots(speed_mps);
            
            // Find the last accepted speed for acceleration check
            const lastAcceptedSpeed = speedBuffer.length > 0 ? speedBuffer[speedBuffer.length - 1].speed : 0.0;
            
            // --- FILTER CHECKS (Retained for sanity checking the hardware SOG) ---

            // 3. Velocity Filter (Max Speed Check)
            if (speedInKnots > MAX_SAILING_SPEED_KNOTS) {
                showStatus(`Speed of ${speedInKnots.toFixed(1)} knots rejected. Exceeds MAX_SAILING_SPEED (${MAX_SAILING_SPEED_KNOTS.toFixed(1)}).`, false);
                return; 
            }
            
            // 4. Acceleration Filter (Max Change Check - still useful for SOG jumps)
            if (time_sec > 0) {
                const speedChange = Math.abs(speedInKnots - lastAcceptedSpeed);
                const acceleration = speedChange / time_sec;
                
                if (acceleration > MAX_ACCELERATION_KNOTS_PER_SEC) {
                    showStatus(`Speed change rejected. Acceleration too high (${acceleration.toFixed(2)} knots/sec).`, false);
                    return; 
                }
            }
            
            // 5. Data Saving and Display Update
            
            // Check against minimum speed threshold
            if (speedInKnots > MIN_SPEED_KNOTS) { 
                
                // DATA ACCEPTED!
                speedBuffer.push({
                    speed: speedInKnots,
                    timestamp: timestamp,
                    lat: currentCoords.latitude,
                    lon: currentCoords.longitude
                });

                lastPosition = position;
                saveData();
                showStatus(`Valid GPS SOG of ${speedInKnots.toFixed(1)} knots accepted. Accuracy: ${currentCoords.accuracy.toFixed(1)}m.`, false, true); 
            } else {
                // DATA REJECTED by MIN_SPEED_KNOTS filter
                lastPosition = position; 
                
                showStatus(`SOG too low (${speedInKnots.toFixed(2)} knots). Assuming stationary.`, false);
            }
            
            // 6. Display Update
            const avgSpeed30 = calculateRollingAverage(AVERAGE_WINDOW_30_SEC);
            const avgSpeed10 = calculateRollingAverage(AVERAGE_WINDOW_10_SEC);

            updateDisplay('avg-speed-30', avgSpeed30);
            updateDisplay('avg-speed-10', avgSpeed10);
            updateChart();
        }

        function handleError(error) { /* ... */ }

        // --- 6. INITIALIZATION ---
        
        function startWatchAfterInitialFix(position) {
            handlePosition(position);

            watchId = navigator.geolocation.watchPosition(
                handlePosition,
                handleError,
                {
                    timeout: 5000,
                    maximumAge: 0, // Request fresh fixes as often as possible
                    enableHighAccuracy: true // Request the best possible fix
                }
            );
        }

        function startGpsWatch() {
            loadData();
            initChart(); 
            
            if (navigator.geolocation) {
                showStatus(speedBuffer.length > 0 ? "GPS Initializing. Displaying historical data..." : "Requesting initial GPS fix...", false);
                
                navigator.geolocation.getCurrentPosition(
                    startWatchAfterInitialFix,
                    handleError,
                    {
                        timeout: 10000, 
                        maximumAge: 0, 
                        enableHighAccuracy: true
                    }
                );
            } else {
                handleError({ code: -1, message: "Geolocation is not supported by this browser." });
            }
        }

        document.addEventListener('DOMContentLoaded', startGpsWatch);
        
        window.onbeforeunload = function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        };
    </script>
</body>
</html>
