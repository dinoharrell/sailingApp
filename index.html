<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Speed Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* ... (Styling remains the same for brevity) ... */
        body { background-color: #0d1117; color: #ffffff; }
        .speed-display { font-size: 5rem; line-height: 1; }
        .unit { font-size: 1.5rem; opacity: 0.7; margin-top: -10px; }
        .data-box { @apply text-center bg-gray-800 p-6 rounded-lg shadow-2xl w-full; margin-bottom: 1.5rem;}
        .chart-box { @apply bg-gray-800 p-4 rounded-lg shadow-2xl w-full; }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen">

    <h1 class="text-xl font-bold mb-6 text-gray-400">
        SAILING SPEED MONITOR (SOG)
    </h1>

    <div class="w-full max-w-lg space-y-4">
        
        <div class="data-box">
            <p class="text-2xl mb-2 text-blue-400">AVG (LAST 10 SEC)</p>
            <p id="avg-speed-10" class="speed-display font-mono text-green-400">--.-</p>
            <p class="unit">KNOTS</p>
        </div>

        <div class="data-box">
            <p class="text-2xl mb-2 text-blue-400">AVG (LAST 30 SEC)</p>
            <p id="avg-speed-30" class="speed-display font-mono text-yellow-400">--.-</p>
            <p class="unit">KNOTS</p>
        </div>

        <div class="chart-box">
             <p class="text-xl mb-2 text-blue-400 text-left">RAW SPEED (LAST 60 SEC)</p>
            <canvas id="speedChart"></canvas>
        </div>

    </div>

    <div class="mt-8 p-3 w-full max-w-lg rounded bg-red-800 text-white hidden" id="status-box">
        <p id="status-message" class="text-sm">Initializing GPS...</p>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const AVERAGE_WINDOW_10_SEC = 10;
        const AVERAGE_WINDOW_30_SEC = 30;
        const GRAPH_WINDOW_SEC = 60;
        const KNOTS_PER_METER_PER_SECOND = 1.94384;
        const DATA_KEY = 'sailingSpeedData'; // Key for Local Storage

        // --- 2. DATA STRUCTURE & GLOBALS ---
        let speedBuffer = [];
        let watchId; 
        let speedChart;

        // --- 3. PERSISTENCE FUNCTIONS ---
        
        /**
         * Attempts to load the speed buffer from Local Storage.
         */
        function loadData() {
            try {
                const storedData = localStorage.getItem(DATA_KEY);
                if (storedData) {
                    // Convert JSON string back to JavaScript array
                    const loadedBuffer = JSON.parse(storedData);
                    
                    // Filter the loaded data to only include the largest required window (60s)
                    // This prevents loading stale data from days ago.
                    const now = Date.now();
                    const timeCutoff = now - (GRAPH_WINDOW_SEC * 1000);
                    
                    speedBuffer = loadedBuffer.filter(reading => reading.timestamp >= timeCutoff);
                    
                    // After loading, we immediately run the calculations to update the display/chart
                    // even before the first new GPS reading arrives.
                    handlePosition({ coords: { speed: null }, timestamp: now });

                    showStatus("Data loaded successfully from previous session.", false);
                } else {
                    speedBuffer = []; // Start fresh if nothing is stored
                }
            } catch (e) {
                console.error("Error loading data from Local Storage:", e);
                speedBuffer = [];
                showStatus("Error loading saved data. Starting fresh.", true);
            }
        }

        /**
         * Saves the current speed buffer to Local Storage.
         */
        function saveData() {
            try {
                // Convert JavaScript array to JSON string for storage
                const dataToStore = JSON.stringify(speedBuffer);
                localStorage.setItem(DATA_KEY, dataToStore);
            } catch (e) {
                console.error("Error saving data to Local Storage:", e);
                showStatus("Error saving data. History may be lost on refresh.", true);
            }
        }


        // --- 4. CORE LOGIC (Averages, Display, Chart) ---

        function calculateRollingAverage(windowSeconds) {
            // ... (Logic remains the same: prunes the buffer, calculates average) ...
            const now = Date.now();
            const timeCutoff = now - (windowSeconds * 1000);

            if (windowSeconds === GRAPH_WINDOW_SEC) {
                speedBuffer = speedBuffer.filter(reading => reading.timestamp >= timeCutoff);
            }
            
            const relevantReadings = speedBuffer.filter(reading => reading.timestamp >= timeCutoff);

            if (relevantReadings.length === 0) { return 0.0; }

            const totalSpeed = relevantReadings.reduce((sum, reading) => sum + reading.speed, 0);
            return totalSpeed / relevantReadings.length;
        }

        function mpsToKnots(mps) { /* ... (Same) ... */ return mps * KNOTS_PER_METER_PER_SECOND; }
        function updateDisplay(elementId, speed) { /* ... (Same) ... */ }
        function showStatus(message, isError = false) { /* ... (Same) ... */ }
        function initChart() { /* ... (Same) ... */ }
        
        function updateChart() {
            if (!speedChart) return;
            const now = Date.now();
            const timeCutoff = now - (GRAPH_WINDOW_SEC * 1000);
            
            const graphData = speedBuffer.map(reading => ({
                x: reading.timestamp,
                y: reading.speed.toFixed(2)
            }));

            speedChart.data.datasets[0].data = graphData;
            speedChart.options.scales.x.min = timeCutoff; 
            speedChart.options.scales.x.max = now;

            speedChart.update('none');
        }

        // --- 5. GEOLOCATION HANDLERS ---

        /**
         * Success handler for the Geolocation API.
         * Note: position.coords.speed may be null if stationary, so we must handle that.
         */
        function handlePosition(position) {
            const currentSpeed_mps = position.coords.speed;
            const timestamp = position.timestamp;

            if (currentSpeed_mps !== null && currentSpeed_mps >= 0) {
                const speedInKnots = mpsToKnots(currentSpeed_mps);
                
                // 1. Add new reading
                speedBuffer.push({
                    speed: speedInKnots,
                    timestamp: timestamp
                });

                // 2. Save the updated buffer (The key change!)
                saveData();
                
                document.getElementById('status-box').classList.add('hidden');
            } 
            
            // 3. Always run the display updates, even if we just loaded old data or are stationary
            const avgSpeed60 = calculateRollingAverage(GRAPH_WINDOW_SEC);
            const avgSpeed30 = calculateRollingAverage(AVERAGE_WINDOW_30_SEC);
            const avgSpeed10 = calculateRollingAverage(AVERAGE_WINDOW_10_SEC);

            updateDisplay('avg-speed-30', avgSpeed30);
            updateDisplay('avg-speed-10', avgSpeed10);
            updateChart();

            // Only show 'waiting' status if the buffer is empty AND we received a null speed update
            if (speedBuffer.length === 0 && (currentSpeed_mps === null || currentSpeed_mps < 0)) {
                showStatus("Waiting for motion/Speed Over Ground (SOG) data...", false);
            }
        }

        function handleError(error) { /* ... (Same) ... */ }

        // --- 6. INITIALIZATION ---

        function startGpsWatch() {
            // 1. Load any previously saved data first
            loadData();
            
            // 2. Initialize the Chart
            initChart(); 
            
            // 3. Start the GPS Watch
            if (navigator.geolocation) {
                showStatus(speedBuffer.length > 0 ? "GPS Initializing. Displaying historical data..." : "Initializing GPS: Waiting for a fix...", false);
                
                watchId = navigator.geolocation.watchPosition(
                    handlePosition,
                    handleError,
                    {
                        enableHighAccuracy: true, 
                        timeout: 5000,            
                        maximumAge: 0             
                    }
                );
            } else {
                handleError({ code: -1, message: "Geolocation is not supported by this browser." });
            }
        }

        document.addEventListener('DOMContentLoaded', startGpsWatch);
        
        // Final cleanup for good practice
        window.onbeforeunload = function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        };

    </script>
</body>
</html>
