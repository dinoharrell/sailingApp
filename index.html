<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Speed Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* ... (Styling remains the same) ... */
        body { background-color: #0d1117; color: #ffffff; }
        .speed-display { font-size: 5rem; line-height: 1; }
        .unit { font-size: 1.5rem; opacity: 0.7; margin-top: -10px; }
        .data-box { @apply text-center bg-gray-800 p-6 rounded-lg shadow-2xl w-full; margin-bottom: 1.5rem;}
        .chart-box { @apply bg-gray-800 p-4 rounded-lg shadow-2xl w-full; }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen">

    <h1 class="text-xl font-bold mb-6 text-gray-400">SAILING SPEED MONITOR v2.2 (SOG)</h1>
    <div class="w-full max-w-lg space-y-4">
        <div class="data-box"><p class="text-2xl mb-2 text-blue-400">AVG (LAST 10 SEC)</p><p id="avg-speed-10" class="speed-display font-mono text-green-400">--.-</p><p class="unit">KNOTS</p></div>
        <div class="data-box"><p class="text-2xl mb-2 text-blue-400">AVG (LAST 30 SEC)</p><p id="avg-speed-30" class="speed-display font-mono text-yellow-400">--.-</p><p class="unit">KNOTS</p></div>
        <div class="chart-box"><p class="text-xl mb-2 text-blue-400 text-left">RAW SPEED (LAST 60 SEC)</p><canvas id="speedChart"></canvas></div>
    </div>
    <div class="mt-8 p-3 w-full max-w-lg rounded bg-red-800 text-white hidden" id="status-box">
        <p id="status-message" class="text-sm">Initializing GPS...</p>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const AVERAGE_WINDOW_10_SEC = 10;
        const AVERAGE_WINDOW_30_SEC = 30;
        const GRAPH_WINDOW_SEC = 60;
        // Keeping your test value for now, we can revert this to 7.0 later.
        const MAX_SAILING_SPEED_KNOTS = 70.0; 
        const KNOTS_PER_METER_PER_SECOND = 1.94384;
        const EARTH_RADIUS_METERS = 6371000;
        const DATA_KEY = 'sailingSpeedData';

        // --- 2. DATA STRUCTURE & GLOBALS (Unchanged) ---
        let speedBuffer = [];
        let watchId; 
        let speedChart;
        let lastPosition = null;

        // --- 3. GEOMETRY FUNCTIONS (Unchanged) ---
        function toRad(degrees) { return degrees * Math.PI / 180; }
        function getDistance(lat1, lon1, lat2, lon2) { /* ... (Same) ... */
            const R = EARTH_RADIUS_METERS;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        }

        function calculateSpeed(current) { /* ... (Same) ... */
            if (!lastPosition) { return 0; }
            const distanceMeters = getDistance(
                lastPosition.coords.latitude, 
                lastPosition.coords.longitude, 
                current.coords.latitude, 
                current.coords.longitude
            );
            const timeSeconds = (current.timestamp - lastPosition.timestamp) / 1000;

            if (timeSeconds > 0) {
                return distanceMeters / timeSeconds;
            }
            return 0;
        }

        // --- 4. PERSISTENCE, CORE LOGIC, CHART (Unchanged) ---
        function loadData() { /* ... (Same) ... */
            try {
                const storedData = localStorage.getItem(DATA_KEY);
                if (storedData) {
                    const loadedBuffer = JSON.parse(storedData);
                    const now = Date.now();
                    const timeCutoff = now - (GRAPH_WINDOW_SEC * 1000);
                    speedBuffer = loadedBuffer.filter(reading => reading.timestamp >= timeCutoff);
                    if(speedBuffer.length > 0) {
                        lastPosition = {
                            coords: {
                                latitude: speedBuffer[speedBuffer.length - 1].lat,
                                longitude: speedBuffer[speedBuffer.length - 1].lon
                            },
                            timestamp: speedBuffer[speedBuffer.length - 1].timestamp
                        };
                    }
                    handlePosition({ coords: { speed: null }, timestamp: now });
                    showStatus("Data loaded successfully from previous session.", false);
                } else {
                    speedBuffer = []; 
                }
            } catch (e) {
                console.error("Error loading data from Local Storage:", e);
                speedBuffer = [];
                showStatus("Error loading saved data. Starting fresh.", true);
            }
        }
        function saveData() { /* ... (Same) ... */ }
        function calculateRollingAverage(windowSeconds) { /* ... (Same) ... */ }
        function mpsToKnots(mps) { return mps * KNOTS_PER_METER_PER_SECOND; }
        function updateDisplay(elementId, speed) { /* ... (Same) ... */ }
        function showStatus(message, isError = false) { /* ... (Same) ... */ }
        function initChart() { /* ... (Same) ... */ }
        function updateChart() { /* ... (Same) ... */ }

        // --- 5. GEOLOCATION HANDLERS (Unchanged logic, relies on faster GPS lock) ---

        function handlePosition(position) {
            const currentCoords = position.coords;
            const timestamp = position.timestamp;
            let speedInKnots = 0;
            
            // 1. Only attempt to calculate speed if we have a previous position
            if (lastPosition) {
                const calculatedSpeed_mps = calculateSpeed(position);
                speedInKnots = mpsToKnots(calculatedSpeed_mps);
                
                // --- VELOCITY FILTER ---
                if (speedInKnots > MAX_SAILING_SPEED_KNOTS) {
                    console.warn(`[FILTER] Rejected speed of ${speedInKnots.toFixed(1)} knots. Outlier.`);
                    return; 
                }
            }

            // 2. If calculated speed is above a minimum threshold (0.05 knots)
            if (speedInKnots > 0.05) { 
                
                // Add new reading to speed buffer
                speedBuffer.push({
                    speed: speedInKnots,
                    timestamp: timestamp,
                    lat: currentCoords.latitude,
                    lon: currentCoords.longitude
                });

                // 3. Update the 'lastPosition' with the current valid reading
                lastPosition = position;
                saveData();
                document.getElementById('status-box').classList.add('hidden');
            } else if (speedInKnots <= 0.05 && speedBuffer.length > 0) {
                 // Update lastPosition even if stationary to maintain accurate time delta for next move
                 lastPosition = position;
            }
            
            // 4. Always update displays and chart based on current buffer state
            const avgSpeed60 = calculateRollingAverage(GRAPH_WINDOW_SEC);
            const avgSpeed30 = calculateRollingAverage(AVERAGE_WINDOW_30_SEC);
            const avgSpeed10 = calculateRollingAverage(AVERAGE_WINDOW_10_SEC);

            updateDisplay('avg-speed-30', avgSpeed30);
            updateDisplay('avg-speed-10', avgSpeed10);
            updateChart();

            // 5. Update status if no speed data is coming in
            if (speedBuffer.length === 0) {
                 showStatus("Waiting for a second GPS fix to calculate speed...", false);
            }
        }

        function handleError(error) { /* ... (Same) ... */
            let message = '';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "GPS Access Denied. Please enable location services for this browser.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Position Unavailable. Check your device's GPS signal.";
                    break;
                case error.TIMEOUT:
                    message = "GPS Timed Out. Try moving to an open area.";
                    break;
                default:
                    message = `An unknown GPS error occurred: ${error.message}`;
            }
            updateDisplay('avg-speed-10', 0);
            updateDisplay('avg-speed-30', 0);
            showStatus(message, true);
        }

        // --- 6. INITIALIZATION (Change is here) ---

        function startGpsWatch() {
            // 1. Load any previously saved data first
            loadData();
            
            // 2. Initialize the Chart
            initChart(); 
            
            // 3. Start the GPS Watch
            if (navigator.geolocation) {
                showStatus(speedBuffer.length > 0 ? "GPS Initializing. Displaying historical data..." : "Waiting for GPS fix...", false);
                
                watchId = navigator.geolocation.watchPosition(
                    handlePosition,
                    handleError,
                    {
                        // Removed enableHighAccuracy: true for faster, more reliable initial lock
                        timeout: 5000,            
                        maximumAge: 0             
                    }
                );
            } else {
                handleError({ code: -1, message: "Geolocation is not supported by this browser." });
            }
        }

        document.addEventListener('DOMContentLoaded', startGpsWatch);
        
        window.onbeforeunload = function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        };
    </script>
</body>
</html>
